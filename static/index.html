<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EURUSD Body Lab</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');

    :root {
      color-scheme: light;
      --bg-1: #f4efe4;
      --bg-2: #dfece6;
      --ink: #14231f;
      --muted: #5a6b64;
      --accent: #ef6457;
      --accent-2: #2f9c8b;
      --card: rgba(255, 255, 255, 0.82);
      --stroke: #d1ddd6;
      --shadow: 0 20px 45px rgba(20, 35, 31, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 15% 20%, rgba(239, 100, 87, 0.12), transparent 45%),
        radial-gradient(circle at 80% 10%, rgba(47, 156, 139, 0.14), transparent 40%),
        linear-gradient(140deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 18px 40px;
    }

    .shell {
      width: min(1100px, 100%);
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 24px;
      animation: rise 600ms ease-out;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 24px;
      padding: 28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .hero h1 {
      font-family: "Fraunces", "Times New Roman", serif;
      font-weight: 700;
      font-size: clamp(2.4rem, 3.5vw, 3.4rem);
      margin: 0 0 12px;
      letter-spacing: -0.02em;
    }

    .hero p {
      margin: 0 0 18px;
      color: var(--muted);
      font-size: 1.05rem;
      line-height: 1.6;
    }

    .pill-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 18px;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      font-size: 0.85rem;
      color: var(--muted);
      background: rgba(255, 255, 255, 0.7);
    }

    .uploader h2 {
      font-size: 1.4rem;
      margin: 0 0 8px;
    }

    .uploader p {
      margin: 0 0 16px;
      color: var(--muted);
      line-height: 1.5;
      font-size: 0.95rem;
    }

    .form-row {
      display: grid;
      gap: 12px;
    }

    .file-field {
      padding: 16px;
      border-radius: 16px;
      border: 1px dashed var(--stroke);
      background: rgba(255, 255, 255, 0.6);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input[type="file"] {
      width: 100%;
      font-family: inherit;
    }

    button {
      border: none;
      padding: 12px 18px;
      border-radius: 14px;
      background: linear-gradient(120deg, var(--accent), #f19b83);
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 150ms ease, box-shadow 150ms ease;
      box-shadow: 0 12px 20px rgba(239, 100, 87, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 24px rgba(239, 100, 87, 0.35);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .status {
      margin-top: 12px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .stats {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      animation: fade 400ms ease;
    }

    .stat {
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255, 255, 255, 0.7);
    }

    .stat span {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .stat strong {
      font-size: 1.1rem;
    }

    .table-wrap {
      margin-top: 18px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      overflow: hidden;
      background: rgba(255, 255, 255, 0.75);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      min-width: 860px;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    thead {
      background: rgba(47, 156, 139, 0.1);
      text-align: left;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--stroke);
    }

    tbody tr:hover {
      background: rgba(47, 156, 139, 0.08);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
    }

    .tag.long {
      background: rgba(47, 156, 139, 0.15);
      color: #1f6f63;
    }

    .tag.short {
      background: rgba(239, 100, 87, 0.18);
      color: #b3473e;
    }

    .note {
      margin-top: 12px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .foot {
      margin-top: 12px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    @keyframes rise {
      from { transform: translateY(14px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fade {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 900px) {
      .shell {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="shell">
    <section class="panel hero">
      <h1>EURUSD Body Lab</h1>
      <p>
        Upload a 15m CSV (UTC-6), the engine shifts it to UTC-5 and simulates
        the body-only X setup. Entry window is 00:00-11:30, time exit at 14:00.
      </p>
      <div class="pill-list">
        <div class="pill">Body cover X only</div>
        <div class="pill">Entry on next open</div>
        <div class="pill">SL from last 3 candles</div>
        <div class="pill">TP on opposite X close</div>
        <div class="pill">R-based report</div>
      </div>
      <div class="note">
        CSV or Numbers format: Time, Open, High, Low, Latest (Latest is treated as Close).
      </div>
    </section>

    <section class="panel uploader">
      <h2>Run Simulation</h2>
      <p>Drop your CSV or Numbers file and review the R report. Only ASCII text used in this UI.</p>
      <form id="upload-form" class="form-row">
        <div class="file-field">
          <label for="file">CSV or Numbers file</label>
          <input id="file" name="file" type="file" accept=".csv,.numbers" required />
        </div>
        <button type="submit" id="run-btn">Analyze</button>
      </form>
      <div class="status" id="status">Idle.</div>

      <div id="summary" class="stats"></div>
      <div id="skipped" class="note"></div>

      <div id="trades" class="table-wrap" hidden>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Entry</th>
              <th>Exit</th>
              <th>Dir</th>
              <th>Entry Px</th>
              <th>Exit Px</th>
              <th>SL</th>
              <th>R</th>
              <th>Reason</th>
              <th>Hold (m)</th>
            </tr>
          </thead>
          <tbody id="trades-body"></tbody>
        </table>
      </div>
      <div class="foot" id="table-note"></div>
    </section>
  </main>

  <script>
    const form = document.getElementById("upload-form");
    const statusEl = document.getElementById("status");
    const runBtn = document.getElementById("run-btn");
    const summaryEl = document.getElementById("summary");
    const skippedEl = document.getElementById("skipped");
    const tradesWrap = document.getElementById("trades");
    const tradesBody = document.getElementById("trades-body");
    const tableNote = document.getElementById("table-note");

    function formatNum(value, digits = 2) {
      if (value === null || value === undefined || Number.isNaN(value)) return "-";
      return Number(value).toFixed(digits);
    }

    function formatPct(value, digits = 1) {
      if (!Number.isFinite(value)) return "-";
      return `${(value * 100).toFixed(digits)}%`;
    }

    function clearResults() {
      summaryEl.innerHTML = "";
      skippedEl.textContent = "";
      tradesBody.innerHTML = "";
      tradesWrap.hidden = true;
      tableNote.textContent = "";
    }

    function renderSummary(summary) {
      const items = [
        { label: "Trades", value: summary.trades },
        { label: "Total R", value: formatNum(summary.total_r) },
        { label: "Win rate", value: formatPct(summary.win_rate) },
        { label: "Avg R", value: formatNum(summary.avg_r) },
        { label: "Avg win", value: formatNum(summary.avg_win_r) },
        { label: "Avg loss", value: formatNum(summary.avg_loss_r) },
        { label: "Profit factor", value: summary.profit_factor === null ? "-" : formatNum(summary.profit_factor) },
        { label: "Max DD", value: formatNum(summary.max_drawdown_r) },
        { label: "TP / SL / Time", value: `${summary.tp_exits} / ${summary.sl_exits} / ${summary.time_exits}` },
        { label: "Avg hold (m)", value: formatNum(summary.avg_hold_minutes, 1) },
        { label: "Candles", value: summary.candles },
        { label: "Timeframe (m)", value: summary.timeframe_minutes ?? "-" }
      ];

      summaryEl.innerHTML = items.map(item => (
        `<div class="stat"><span>${item.label}</span><strong>${item.value}</strong></div>`
      )).join("");
    }

    function renderSkipped(skipped) {
      const parts = [
        `Outside window: ${skipped.outside_window}`,
        `Insufficient history: ${skipped.insufficient_history}`,
        `Invalid risk: ${skipped.invalid_risk}`,
        `Same candle invalid: ${skipped.invalid_same_candle}`,
        `No exit: ${skipped.no_exit}`
      ];
      skippedEl.textContent = `Skipped -> ${parts.join(" | ")}`;
    }

    function renderTrades(trades) {
      const maxRows = 300;
      const show = trades.slice(0, maxRows);
      tradesBody.innerHTML = show.map((trade, idx) => {
        const dirClass = trade.direction === "long" ? "long" : "short";
        const dirLabel = trade.direction === "long" ? "LONG" : "SHORT";
        return `
          <tr>
            <td>${idx + 1}</td>
            <td>${trade.entry_time}</td>
            <td>${trade.exit_time}</td>
            <td><span class="tag ${dirClass}">${dirLabel}</span></td>
            <td>${formatNum(trade.entry_price, 5)}</td>
            <td>${formatNum(trade.exit_price, 5)}</td>
            <td>${formatNum(trade.sl, 5)}</td>
            <td>${formatNum(trade.r_multiple, 2)}</td>
            <td>${trade.exit_reason}</td>
            <td>${trade.hold_minutes}</td>
          </tr>
        `;
      }).join("");

      tradesWrap.hidden = trades.length === 0;
      if (trades.length > maxRows) {
        tableNote.textContent = `Showing first ${maxRows} of ${trades.length} trades.`;
      } else if (trades.length > 0) {
        tableNote.textContent = `Showing ${trades.length} trades.`;
      }
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      clearResults();
      statusEl.textContent = "Uploading and analyzing...";
      runBtn.disabled = true;

      const formData = new FormData(form);

      try {
        const response = await fetch("/analyze", {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || "Request failed");
        }

        const report = await response.json();
        renderSummary(report.summary);
        renderSkipped(report.skipped);
        renderTrades(report.trades);
        statusEl.textContent = `Done. Range: ${report.summary.start_time} -> ${report.summary.end_time}`;
      } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
      } finally {
        runBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
